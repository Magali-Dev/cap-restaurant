{% extends 'base.html.twig' %}

{% block title %}Limitation des rÃ©servations - Admin{% endblock %}

{% block body %}
<div class="admin-container">

    <div class="admin-header">
        <div class="header-main">
            <h1>âš™ï¸ Limitation des rÃ©servations</h1>
            <p class="header-subtitle">ContrÃ´lez la disponibilitÃ© des rÃ©servations en ligne</p>
        </div>
        <div class="header-actions">
            <a href="{{ path('admin_dashboard') }}" class="btn btn-icon">
                <span class="btn-icon">â†</span>
                Tableau de bord
            </a>
            <a href="{{ path('admin_reservations') }}" class="btn btn-outline">
                <span class="btn-icon">ğŸ“…</span>
                Voir les rÃ©servations
            </a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">
            <div class="alert-content">
                <span class="alert-icon">âœ…</span>
                <span class="alert-message">{{ message }}</span>
            </div>
        </div>
    {% endfor %}

    <div class="limitation-grid">

        <!-- Carte 1 : DÃ©sactivation complÃ¨te -->
        <div class="limitation-card card-primary">
            <div class="card-icon">ğŸ›‘</div>
            <div class="card-content">
                <div class="card-header">
                    <h3>DÃ©sactivation complÃ¨te</h3>
                    <div class="status-indicator {{ status.online_enabled ? 'status-on' : 'status-off' }}">
                        <span class="status-dot"></span>
                        {{ status.online_enabled ? 'ActivÃ©' : 'DÃ©sactivÃ©' }}
                    </div>
                </div>
                <p class="card-description">
                    Bloquer immÃ©diatement toutes les nouvelles rÃ©servations en ligne.
                </p>
                <div class="card-actions">
                    <form method="post" class="inline-form">
                        {% if status.online_enabled %}
                            <button type="submit" name="action" value="disable_all" 
                                    class="btn btn-danger btn-full"
                                    onclick="return confirm('ÃŠtes-vous sÃ»r de vouloir dÃ©sactiver toutes les rÃ©servations en ligne ?')">
                                <span class="btn-icon">ğŸš«</span>
                                DÃ©sactiver les rÃ©servations
                            </button>
                        {% else %}
                            <button type="submit" name="action" value="enable_all" 
                                    class="btn btn-success btn-full">
                                <span class="btn-icon">âœ…</span>
                                Activer les rÃ©servations
                            </button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Carte 2 : Blocage par heures -->
        <div class="limitation-card">
            <div class="card-icon">â°</div>
            <div class="card-content">
                <div class="card-header">
                    <h3>Heures spÃ©cifiques</h3>
                    <div class="stat-badge" id="hoursCount">
                        {{ status.disabled_hours|length }} crÃ©neau(x) bloquÃ©(s)
                    </div>
                </div>
                <p class="card-description">
                    EmpÃªcher les rÃ©servations pour certains crÃ©neaux horaires.
                </p>

                <form method="post" class="hours-form">
                    <div class="time-slots-section">

                        <h4 class="section-title">CrÃ©neaux du midi</h4>
                        <div class="time-slots-grid">
                            {% for slot in all_time_slots %}
                                {% if slot >= '12:00' and slot <= '14:00' %}
                                    <label class="time-slot-item {{ slot in status.disabled_hours ? 'disabled' : '' }}">
                                        <input type="checkbox" name="disabled_hours[]" value="{{ slot }}"
                                               {% if slot in status.disabled_hours %}checked{% endif %}>
                                        <span class="time-slot-check"></span>
                                        <span class="time-slot-label">{{ slot }}</span>
                                    </label>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <h4 class="section-title">CrÃ©neaux du soir</h4>
                        <div class="time-slots-grid">
                            {% for slot in all_time_slots %}
                                {% if slot >= '19:00' and slot <= '22:30' %}
                                    <label class="time-slot-item {{ slot in status.disabled_hours ? 'disabled' : '' }}">
                                        <input type="checkbox" name="disabled_hours[]" value="{{ slot }}"
                                               {% if slot in status.disabled_hours %}checked{% endif %}>
                                        <span class="time-slot-check"></span>
                                        <span class="time-slot-label">{{ slot }}</span>
                                    </label>
                                {% endif %}
                            {% endfor %}
                        </div>

                    </div>

                    <div class="form-actions">
                        <button type="submit" name="action" value="disable_hours" class="btn btn-primary btn-full">
                            <span class="btn-icon">ğŸ’¾</span>
                            Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Carte 3 : Blocage par dates -->
        <div class="limitation-card">
            <div class="card-icon">ğŸ“…</div>
            <div class="card-content">
                <div class="card-header">
                    <h3>Dates spÃ©cifiques</h3>
                    <div class="stat-badge" id="datesCount">
                        {{ status.disabled_dates|length }} date(s) bloquÃ©e(s)
                    </div>
                </div>
                <p class="card-description">
                    Fermer les rÃ©servations en ligne pour certains jours.
                </p>

                <form method="post" id="datesForm">
                    <div class="dates-section">

                        <div class="selected-dates-container">
                            <h4 class="section-title">Dates bloquÃ©es</h4>
                            <div id="selectedDates" class="selected-dates">
                                {% if status.disabled_dates is empty %}
                                    <div class="empty-state">
                                        <span class="empty-icon">ğŸ“…</span>
                                        <span class="empty-text">Aucune date bloquÃ©e</span>
                                    </div>
                                {% else %}
                                    {% for date in status.disabled_dates %}
                                        {% if date is iterable %}
                                            {% set dateString = date|first %}
                                        {% elseif date is same as(null) %}
                                            {% set dateString = '' %}
                                        {% else %}
                                            {% set dateString = date|date('Y-m-d') %}
                                        {% endif %}
                                        <div class="date-tag">
                                            <span class="date-text">{{ dateString|date('d/m/Y') }}</span>
                                            <button type="button" class="remove-date" data-date="{{ dateString }}">
                                                <span class="remove-icon">Ã—</span>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="date-input-section">
                            <h4 class="section-title">Ajouter une date</h4>
                            <div class="date-input-group">
                                <input type="date" id="datePicker" class="form-input" min="{{ "now"|date('Y-m-d') }}">
                                <button type="button" id="addDateBtn" class="btn btn-outline btn-icon">
                                    <span class="btn-icon">â•</span>
                                    Ajouter
                                </button>
                            </div>
                        </div>

                        <input type="hidden" name="disabled_dates" id="disabledDatesInput"
                               value="{% for date in status.disabled_dates %}{{ date|date('Y-m-d') }}{% if not loop.last %},{% endif %}{% endfor %}">
                    </div>

                    <div class="form-actions">
                        <button type="submit" name="action" value="disable_dates" class="btn btn-primary btn-full">
                            <span class="btn-icon">ğŸ’¾</span>
                            Enregistrer les dates
                        </button>
                    </div>
                </form>

            </div>
        </div>

    </div>
</div>
{% endblock %}
